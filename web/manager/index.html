<!-- manager/index.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quáº£n LÃ½ Bot - Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-brand">ğŸ¤– Bot Manager</div>
        <div class="nav-links" id="nav-links">
            <a class="nav-link" href="/home/">ğŸ  Home</a>
            <a class="nav-link active" href="/manager/" data-require-login="true">âš™ï¸ Manager</a>
            <a class="nav-link" href="/bots/" data-require-login="true">ğŸ¤– Bot</a>
            <a class="nav-link" href="/create/" data-require-login="true">â• Táº¡o</a>
            <!-- More pages in dropdown -->
            <button class="theme-toggle" id="theme-toggle-nav">ğŸŒ™</button>
            <div class="nav-menu-btn" id="nav-menu-btn">â˜°</div>
            <div class="auth-buttons" id="auth-buttons" style="display: flex; gap: 5px; align-items: center;">
                <button class="nav-link" id="nav-login-btn">ğŸ” ÄÄƒng nháº­p</button>
                <button class="nav-link active" id="nav-register-btn" style="margin-left: 5px;">ğŸ“ ÄÄƒng kÃ½</button>
            </div>
            <div class="user-profile" id="user-profile" style="display: none;">
                <div class="user-profile-btn" id="user-profile-btn">
                    <div class="profile-avatar" id="profile-avatar">A</div>
                    <span class="profile-name" id="profile-name">User</span>
                    <span style="font-size: 12px;">â–¼</span>
                </div>
                <div class="profile-dropdown" id="profile-dropdown">
                    <div class="profile-dropdown-item" id="profile-info">
                        <span>ğŸ‘¤</span>
                        <span>ThÃ´ng tin cÃ¡ nhÃ¢n</span>
                    </div>
                    <div class="profile-dropdown-divider"></div>
                    <div class="profile-dropdown-item" id="profile-settings">
                        <span>âš™ï¸</span>
                        <span>CÃ i Ä‘áº·t tÃ i khoáº£n</span>
                    </div>
                    <div class="profile-dropdown-divider"></div>
                    <div class="profile-dropdown-item" id="logout-btn" style="color: #ef4444;">
                        <span>ğŸšª</span>
                        <span>ÄÄƒng xuáº¥t</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Navigation Dropdown -->
        <div class="nav-dropdown" id="nav-dropdown">
            <div class="nav-dropdown-section">
                <div class="nav-dropdown-title">ğŸ¯ ChÃ­nh</div>
                <a class="nav-dropdown-item" href="/home/">ğŸ  Trang chá»§</a>
                <a class="nav-dropdown-item active" href="/manager/" data-require-login="true">âš™ï¸ Manager</a>
                <a class="nav-dropdown-item" href="/bots/" data-require-login="true">ğŸ¤– Quáº£n lÃ½ Bot</a>
                <a class="nav-dropdown-item" href="/create/" data-require-login="true">â• Táº¡o Bot</a>
            </div>
            <div class="nav-dropdown-section">
                <div class="nav-dropdown-title">ğŸ’° Dá»‹ch vá»¥</div>
                <a class="nav-dropdown-item" href="/rental/" data-require-login="true">ğŸ’° ThuÃª Bot</a>
                <a class="nav-dropdown-item" href="/commands/" data-require-login="true">ğŸ›’ Mua Lá»‡nh</a>
            </div>
            <div class="nav-dropdown-section">
                <div class="nav-dropdown-title">ğŸ“Š Quáº£n lÃ½</div>
                <a class="nav-dropdown-item" href="/statistics/" data-require-login="true">ğŸ“Š Thá»‘ng KÃª</a>
                <a class="nav-dropdown-item" href="/users/" data-require-login="true">ğŸ‘¥ Users</a>
                <a class="nav-dropdown-item" href="/history/" data-require-login="true">ğŸ“ Lá»‹ch Sá»­</a>
            </div>
            <div class="nav-dropdown-section">
                <div class="nav-dropdown-title">âš™ï¸ CÃ i Ä‘áº·t</div>
                <a class="nav-dropdown-item" href="/settings/" data-require-login="true">âš™ï¸ Cáº¥u HÃ¬nh</a>
                <a class="nav-dropdown-item" href="/theme/" data-require-login="true">ğŸ¨ TÃ¹y Chá»‰nh</a>
            </div>
        </div>
    </nav>
    
    <div class="page manager-page active" id="manager-page">
        <div class="container">
            <!-- Pháº§n 1: Danh sÃ¡ch -->
            <div class="panel list-panel">
                <div class="panel-header">
                    <span>Danh SÃ¡ch</span>
                </div>
                <div class="panel-content">
                    <div class="tabs">
                        <button class="tab active" data-tab="groups">NhÃ³m</button>
                        <button class="tab" data-tab="friends">Báº¡n BÃ¨</button>
                    </div>
                    <div id="groups-list" class="list-content"></div>
                    <div id="friends-list" class="list-content" style="display: none;"></div>
                </div>
            </div>

            <!-- Pháº§n 2: Log & Composer -->
            <div class="panel log-panel">
                <div class="panel-header">
                    <span>Log Tin Nháº¯n & Events</span>
                    <span class="badge" id="log-count">0</span>
                </div>
                <div class="log-messages" id="log-content">
                    <div class="log-entry">
                        <div class="log-box">
                            <div class="log-header">
                                <div>ğŸ“‹ Tin nháº¯n má»›i <span class="message-count">#1</span></div>
                                <span class="account-badge">Acc 1 (V H Ä)</span>
                            </div>
                            <div class="log-content-area">
                                <div class="log-row">
                                    <span class="log-icon">ğŸ’¬</span>
                                    <span class="log-label">Message:</span>
                                    <span class="log-value">Bot Ä‘Ã£ sáºµn sÃ ng nháº­n lá»‡nh</span>
                                </div>
                                <div class="log-row">
                                    <span class="log-icon">ğŸ‘¤</span>
                                    <span class="log-label">User:</span>
                                    <span class="log-value">Bot System</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Message Composer -->
                <div class="message-composer" id="message-composer">
                    <div class="composer-input-group">
                        <textarea class="composer-textarea" id="composer-textarea" placeholder="Nháº­p tin nháº¯n..." rows="1"></textarea>
                        <button class="composer-send-btn" id="composer-send-btn">ğŸ“¤ Gá»­i</button>
                    </div>
                    <div class="composer-options">
                        <div class="composer-option">
                            <span>TTL:</span>
                            <input type="number" id="composer-ttl" value="0" min="0" step="1000" placeholder="0ms">
                        </div>
                        <div class="composer-option">
                            <button id="composer-send-all">ğŸ“¢ All</button>
                        </div>
                        <div class="composer-option">
                            <button id="composer-run-cmd">âš¡ Lá»‡nh</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/script.js"></script>
    <script>
        // Socket.IO Connection cho Manager page
        let socket = null;
        let socketConnected = false;
        
        // Khá»Ÿi táº¡o Socket.IO connection
        try {
            if (typeof io !== 'undefined') {
                socket = io(window.location.origin, {
                    transports: ['websocket', 'polling'],
                    reconnection: true,
                    reconnectionDelay: 1000,
                    reconnectionAttempts: 10
                });

                // Connection handlers
                socket.on('connect', function() {
                    console.log('âœ… Manager: Connected to server');
                    socketConnected = true;
                    if (typeof window.addLog === 'function') {
                        window.addLog('event', 'ğŸ”— SYSTEM', 'ÄÃ£ káº¿t ná»‘i vá»›i bot server');
                    }
                });

                socket.on('disconnect', function() {
                    console.log('âŒ Manager: Disconnected from server');
                    socketConnected = false;
                    if (typeof window.addLog === 'function') {
                        window.addLog('event', 'âš ï¸ SYSTEM', 'Máº¥t káº¿t ná»‘i vá»›i bot server');
                    }
                });

                // Nháº­n log tá»« bot
                socket.on('new_log', function(logData) {
                    console.log('ğŸ“¨ Manager: New log:', logData);
                    handleNewLog(logData);
                });

                // Nháº­n bot updates
                socket.on('bot_update', function(botData) {
                    console.log('ğŸ¤– Manager: Bot update:', botData);
                });

                // Nháº­n connection established
                socket.on('connection_established', function(data) {
                    console.log('âœ… Manager: Connection established:', data);
                });
            } else {
                console.warn('âš ï¸ Socket.IO library not loaded');
            }
        } catch (error) {
            console.error('âŒ Manager: Socket.IO connection error:', error);
        }

        // HÃ m xá»­ lÃ½ log tá»« bot
        function handleNewLog(logData) {
            const { type, message, timestamp, metadata } = logData;
            
            // Äá»£i script.js load xong (cÃ³ thá»ƒ máº¥t vÃ i giÃ¢y)
            if (typeof window.addLog !== 'function') {
                console.warn('addLog function not available yet, retrying...');
                setTimeout(() => handleNewLog(logData), 500);
                return;
            }
            
            if (type === 'message' && metadata) {
                // Log tin nháº¯n
                window.addLog('message', metadata.author_name || 'User', message, {
                    userId: metadata.author_id,
                    userName: metadata.author_name,
                    threadId: metadata.thread_id,
                    threadName: metadata.group_name || 'Unknown Group',
                    threadType: metadata.thread_type || 'ThreadType.GROUP',
                    messageId: metadata.message_id || '',
                    account: metadata.bot_name || 'Bot'
                });
            } else if (type === 'command' && metadata) {
                // Log command
                const status = metadata.success ? 'âœ…' : 'âŒ';
                window.addLog('event', status + ' COMMAND', message, metadata);
            } else if (type === 'event') {
                // Log event
                window.addLog('event', 'âš™ï¸ EVENT', message, metadata);
            } else if (type === 'error') {
                // Log error
                window.addLog('event', 'âŒ ERROR', message, metadata);
            }
        }
    </script>
</body>
</html>